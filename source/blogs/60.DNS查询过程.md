---
layout: post
title: DNS查询过程
category: js
tagline: 'Supporting tagline'
tags: [Other]
description:
date: 2019-9-25 18:10:20
---

### 基本概念

- DNS 域名解析服务

  我们知道网络上的计算机被赋予了 IP 地址，通过这个 IP 地址就能访问到对应的计算机。但是为了便于记忆，人们更倾向于用包含字母数字的信息来访问，于是便有了域名，比如www.xinghunm.com。但是当通过域名访问时，我们怎么能知道该域名对应的是哪台计算机呢？
  这就需要 DNS(Domain Name System)服务了，它提供域名到 IP 地址之间的解析服务，也就是说你给我域名，我还你 IP...

- 域名空间结构

  域名空间结构如下：
  位于最顶层的是根，用点(·)表示，通常我们都会省略这个点，比如www.xinghunm.com实际可以表示成www.xinghunm.com.。顶级域名是域名中最后一部分(不考虑根)，`.com`就是www.xinghunm.com中的顶级域名，二级域名就是xinghunm，其他低层级域名以此类推。
  ![](http://blog-bed.oss-cn-beijing.aliyuncs.com/60.DNS%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B/domain-structure.png)
  需要注意的是域名的层级并不是绝对的，比如顶级域名`.com`，在`.com.cn`域名结构中`.com`就是在`.cn`这个国家顶级域名下的二级域名。

- [根 DNS 服务器](https://zh.wikipedia.org/wiki/%E6%A0%B9%E7%B6%B2%E5%9F%9F%E5%90%8D%E7%A8%B1%E4%BC%BA%E6%9C%8D%E5%99%A8)

  根 DNS 服务器是是互联网域名解析系统(DNS)中最高级别的域名服务器(就像国家元首一样)，负责返回顶级域的域名服务器地址。通常网络上传言根 DNS 服务器只有 13 台，这种说法并不准确，实际上根 DNS 服务器服务器地址数量是 13 个，通过[任播](https://zh.wikipedia.org/wiki/%E4%BB%BB%E6%92%AD)技术，可以在全球设立这些 IP 的镜像站点，实际的根 DNS 服务器达上千台。
  根 DNS 服务器包含了所有顶级域名服务器的名称和 IP， 就像图书馆中指向不同类型书籍的索引。
  根 DNS 服务器查找，是将网址转换为 IP 的第一步，它将返回要继续查找的顶级域名服务器的 IP。

  ```
  //根服务器名称
  a.root-servers.net.
  b.root-servers.net.
  c.root-servers.net.
  d.root-servers.net.
  e.root-servers.net.
  f.root-servers.net.
  g.root-servers.net.
  h.root-servers.net.
  i.root-servers.net.
  j.root-servers.net.
  k.root-servers.net.
  l.root-servers.net.
  m.root-servers.net.
  ```

- TLD(Top-level domain)名称服务器
  [名称服务器](https://zh.wikipedia.org/wiki/%E5%90%8D%E7%A7%B0%E6%9C%8D%E5%8A%A1%E5%99%A8)就是提供域名到 IP 地址间映射的服务器。
  TLD 名称服务器，即顶级域名称服务器(就像国家元首下的各个省长一样)，它负责管理注册在`.com、.cn、.org...`等顶级域名下的二级域名。它将返回要继续查找的权威名称服务器的 IP。

- 权威名称服务器

  管理一个区域的域名服务器，一般指顶级域下的二级、三级、四级等域名服务器， 就像省长下的市长、区长、乡长等。TLD 名称服务器也算是权威名称服务器，但是其相对特殊，一般单独划作一类。
  权威名称服务器是名称服务器查询的最后一步，它将把请求地址的 IP 地址返回给发出初始请求的 DNS Recursor（图书管理员）。当然权威名称服务器查询有可能会查询多次，比如到二级、三级。

- 本地域名服务器

  本地域名服务器像一个图书管理员，被请求在图书馆的某个地方找到一本特定的书。当客户端发送请求时，首先就向本地域名服务器查询，如果它回答不了，它会代替客户端发送查询的请求。

### DNS 查找流程

DNS 查找中客户端与浏览器、本地 DNS 之间的查询方式是递归查询；本地 DNS 服务器与根域及其子域之间的查询方式是迭代查询。
在浏览器输入 URL 回车后，首先有一个递归查找的过程：
![](http://blog-bed.oss-cn-beijing.aliyuncs.com/60.DNS%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B/dns-recursion.png)

- 首先在浏览器缓存中查找
- 在本地 hosts 文件中查找
- 在 DNS 解析器缓存查找
- 在本地 DNS 服务器查找

以上任何一个步骤找到了都会结束查询流程。如果没有查询到，则根据设置的转发器(为其他 DNS 服务器完成 DNS 查询的 DNS 服务器)进行查找，如果没有采用转发模式则进行迭代查找：
