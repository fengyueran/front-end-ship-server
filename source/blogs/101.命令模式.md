# 命令模式

在讨论命令模式之前，先来实现一个画图(示意)的功能：

```ts
enum Status {
  On,
  Off,
}

class TV {
  status = Status.Off;

  turnOn = () => {
    this.status = Status.On;
    console.log("电视已打开");
  };

  turnOff = () => {
    this.status = Status.Off;
    console.log("电视已关闭");
  };
}

enum Brightness {
  Low,
  High,
}

class Light {
  brightness: Brightness;

  open = () => {
    if (this.brightness === undefined) {
      this.setBrightness(Brightness.Low);
    } else if (this.brightness === Brightness.Low) {
      this.setBrightness(Brightness.High);
    } else if (this.brightness === Brightness.High) {
      this.setBrightness();
    }
  };

  setBrightness = (brightness?: Brightness) => {
    this.brightness = brightness;
    if (this.brightness === undefined) {
      console.log("电灯已关闭");
    } else if (this.brightness === Brightness.Low) {
      console.log("电灯已打开，亮度低");
    } else if (this.brightness === Brightness.High) {
      console.log("电灯已打开，亮度高");
    }
  };
}

class RemoteControl {
  private undoStack: (Status | Brightness)[] = [];
  private redoStack: (Status | Brightness)[] = [];
  constructor(private tigger: Light | TV) {}

  onButtonPressed = () => {
    if (this.tigger instanceof Light) {
      this.tigger.open();
      this.undoStack.push(this.tigger.brightness);
    } else if (this.tigger instanceof TV) {
      if (this.tigger.status === Status.On) {
        this.tigger.turnOff();
      } else {
        this.tigger.turnOn();
      }
      this.undoStack.push(this.tigger.status);
    }
    this.redoStack = []; // 清空重做栈，因为新命令改变了状态
  };

  private executeUndoCommand = (command: Status | Brightness) => {
    if (this.tigger instanceof Light) {
      if (command === Brightness.High) {
        this.tigger.setBrightness(Brightness.Low);
      } else if (command === Brightness.Low) {
        this.tigger.setBrightness();
      } else {
        this.tigger.setBrightness(Brightness.High);
      }
    } else if (this.tigger instanceof TV) {
      if (command === Status.Off) {
        this.tigger.turnOn();
      } else {
        this.tigger.turnOff();
      }
    }
  };

  private executeRedoCommand = (command: Status | Brightness) => {
    if (this.tigger instanceof Light) {
      if (command === Brightness.High) {
        this.tigger.setBrightness(Brightness.High);
      } else if (command === Brightness.Low) {
        this.tigger.setBrightness(Brightness.Low);
      } else {
        this.tigger.setBrightness();
      }
    } else if (this.tigger instanceof TV) {
      if (command === Status.Off) {
        this.tigger.turnOff();
      } else {
        this.tigger.turnOn();
      }
    }
  };

  undo = () => {
    if (this.undoStack.length > 0) {
      const command = this.undoStack.pop();
      this.executeUndoCommand(command);
      this.redoStack.push(command);
    }
  };

  redo = () => {
    if (this.redoStack.length > 0) {
      const command = this.redoStack.pop();
      this.executeRedoCommand(command);
      this.undoStack.push(command);
    }
  };
}

//客户端代码
const testOperateTV = () => {
  const tv = new TV();
  const remote = new RemoteControl(tv);

  remote.onButtonPressed(); // 输出：电视已打开
  remote.onButtonPressed(); // 输出：电视已关闭

  // 撤销最后一个命令（关闭电视）
  remote.undo(); // 输出：电视已打开

  // 重做撤销的命令
  remote.redo(); // 输出：电视已关闭
};

testOperateTV();

//客户端代码
const testOperateLight = () => {
  const light = new Light();
  const remote = new RemoteControl(light);

  remote.onButtonPressed(); // 输出：电灯已打开，亮度低
  remote.onButtonPressed(); // 输出：电灯已打开，亮度高
  remote.onButtonPressed(); // 输出：电灯已关闭

  // 撤销最后一个命令（关闭电灯）
  remote.undo(); // 输出：电灯已打开，亮度高

  // 撤销最后倒数第二个命令（电灯已打开，亮度高）
  remote.undo(); // 输出：电灯已打开，亮度低

  // 重做撤销的命令
  remote.redo(); // 输出：电灯已打开，亮度高
};
testOperateLight();
```

命令模式

```ts
interface Command {
  execute: () => void;
  undo: () => void;
}

class RemoteControl {
  private undoStack: Command[] = [];
  private redoStack: Command[] = [];

  onButtonPressed = (command: Command) => {
    command.execute();
    this.undoStack.push(command);
    this.redoStack = []; // 清空重做栈，因为新命令改变了状态
  };

  undo = () => {
    if (this.undoStack.length > 0) {
      const command = this.undoStack.pop();
      command.undo();
      this.redoStack.push(command);
    }
  };

  redo = () => {
    if (this.redoStack.length > 0) {
      const command = this.redoStack.pop();
      command.execute();
      this.undoStack.push(command);
    }
  };
}

enum Status {
  On,
  Off,
}

class TV {
  status = Status.Off;

  turnOn = () => {
    this.status = Status.On;
    console.log("电视已打开");
  };

  turnOff = () => {
    this.status = Status.Off;
    console.log("电视已关闭");
  };
}

enum Brightness {
  Low,
  High,
}

class Light {
  brightness: Brightness;

  open = () => {
    if (this.brightness === undefined) {
      this.setBrightness(Brightness.Low);
    } else if (this.brightness === Brightness.Low) {
      this.setBrightness(Brightness.High);
    } else if (this.brightness === Brightness.High) {
      this.setBrightness();
    }
  };

  setBrightness = (brightness?: Brightness) => {
    this.brightness = brightness;
    if (this.brightness === undefined) {
      console.log("电灯已关闭");
    } else if (this.brightness === Brightness.Low) {
      console.log("电灯已打开，亮度低");
    } else if (this.brightness === Brightness.High) {
      console.log("电灯已打开，亮度高");
    }
  };
}

class TurnOnTVCommand implements Command {
  constructor(private tv: TV) {}

  execute = () => {
    this.tv.turnOn();
  };

  undo = () => {
    this.tv.turnOff();
  };
}

class TurnOffTVCommand implements Command {
  constructor(private tv: TV) {}

  execute = () => {
    this.tv.turnOff();
  };

  undo = () => {
    this.tv.turnOn();
  };
}
//客户端代码
const testOperateTV = () => {
  const tv = new TV();
  const turnOnCommand = new TurnOnTVCommand(tv);
  const turnOffCommand = new TurnOffTVCommand(tv);
  const remote = new RemoteControl();

  // 执行命令
  remote.onButtonPressed(turnOnCommand); // 输出：电视已打开
  remote.onButtonPressed(turnOffCommand); // 输出：电视已关闭

  // 撤销最后一个命令（关闭电视）
  remote.undo(); // 输出：电视已打开

  // 重做撤销的命令
  remote.redo(); // 输出：电视已关闭
};

testOperateTV();

class LowBrightnessLightCommand implements Command {
  constructor(private light: Light) {}

  execute = () => {
    this.light.setBrightness(Brightness.Low);
  };

  undo = () => {
    this.light.setBrightness();
  };
}

class HighBrightnessLightCommand implements Command {
  constructor(private light: Light) {}

  execute = () => {
    this.light.setBrightness(Brightness.High);
  };

  undo = () => {
    this.light.setBrightness(Brightness.Low);
  };
}

class TurnOffLightCommand implements Command {
  constructor(private light: Light) {}

  execute = () => {
    this.light.setBrightness();
  };

  undo = () => {
    this.light.setBrightness(Brightness.High);
  };
}

//客户端代码
const testOperateLight = () => {
  const light = new Light();
  const lowBrightnessCommand = new LowBrightnessLightCommand(light);
  const highBrightnessCommand = new HighBrightnessLightCommand(light);
  const turnOffCommand = new TurnOffLightCommand(light);
  const remote = new RemoteControl();

  remote.onButtonPressed(lowBrightnessCommand); // 输出：电灯已打开，亮度低
  remote.onButtonPressed(highBrightnessCommand); // 输出：电灯已打开，亮度高
  remote.onButtonPressed(turnOffCommand); // 输出：电灯已关闭

  // 撤销最后一个命令（关闭电灯）
  remote.undo(); // 输出：电灯已打开，亮度高

  // 撤销最后倒数第二个命令（电灯已打开，亮度高）
  remote.undo(); // 输出：电灯已打开，亮度低

  // 重做撤销的命令
  remote.redo(); // 输出：电灯已打开，亮度高
};
testOperateLight();
```
