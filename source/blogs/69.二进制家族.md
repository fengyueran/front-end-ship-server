---
title: 二进制家族
tags: [Http]
type: SHORT_ANSWER
date: 2019-1-15 18:10:20
---

buffer, ArrayBuffer, Bytes, Unit8Array, Blob, File

### Blob

Blob 即 binary large object，直译就是二进制大对象，可以简单地理解为二进制数据的容器，它的数据可以按文本或二进制的格式进行读取。

在 js 中有两个构造函数 Blob 和 File 来生成 Blob 对象，File 继承了 Blob 并作了相应的扩展以支持用户系统上的文件。

在前端中主要有以下两种方式获取 File 对象：

- 通过`<input />`标签选择文件

- 通过拖曳产生的 DataTransfer 对象

#### 创建 Blob

**语法**

```js
const blob = new Blob(array, options);
```

**参数**

- array
  array 为 ArrayBuffer, ArrayBufferView, Blob, String 等对象构成的 Array。
- options

  可选参数，有两个属性：

  - type

    默认值为 ""，表示放入到 blob 中的数组内容的 MIME 类型。

  - endings

    默认值为"transparent"，用于指定包含行结束符`\n` 的字符串如何被写入。
    有两个值
    a) "native"，代表行结束符会被更改为适合宿主操作系统文件系统的换行符
    b) "transparent"，代表会保持 blob 中保存的结束符不变

**实例**

```js
const obj = { hello: 'world' };
const blob = new Blob([JSON.stringify(obj, null, 2)], {
  type: 'application/json',
});
```

#### Blob 实用功能

- 生成 URL 供图片使用

  可以通过`window.URL.createObjectURL(blob)`生成 blob URL(类似`blob:https://www.google.com.hk/ad882004-b8b2-4d56-846b-909d19347a81`)，该 URL 只在浏览器内部有效。

  ```html
  <html>
    <input type="file" id="image" />
    <img id="img" style="width: 300px; height: 300px" />
    <script>
      document.getElementById('image').addEventListener(
        'change',
        function (e) {
          const file = this.files[0];
          const img = document.getElementById('img');
          const url = window.URL.createObjectURL(file);
          img.src = url;
          img.onload = () => {
            window.URL.revokeObjectURL(url);
          };
        },
        false
      );
    </script>
  </html>
  ```

- 生成 URL 供下载

  生成 Blob URL 后赋值给 a.download 属性，然后点击这个链接就可以实现下载了。

  ```js
  const blob = new Blob(['Hello World']);
  const url = window.URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.setAttribute('href', url);
  a.setAttribute('download', 'test.txt');
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();

  setTimeout(() => {
    //revokeObjectURL释放一个之前通过调用 URL.createObjectURL() 创建的 URL 对象
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  });
  ```

- [Blob 实现文件分片上传](https://github.com/fengyueran/front-end-ship-demo/tree/master/packages/binary-family)

  通过`Blob.slice(start,end)`可以将大 Blob 分割为多个小 Blob， 然后通过 xhr.send 发送 Blob 对象。
  html:

  ```html
  <html>
    <body>
      <input type="file" id="input" />
      <script>
        function upload(blob) {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', '/upload', true);
          xhr.setRequestHeader('Content-Type', 'text/plain');
          xhr.send(blob);
        }

        document.getElementById('input').addEventListener(
          'change',
          function (e) {
            const blob = this.files[0];
            const CHUNK_SIZE = 10;
            const SIZE = blob.size;
            let start = 0;
            let end = CHUNK_SIZE;
            while (start < SIZE) {
              upload(blob.slice(start, end));
              start = end;
              end = start + CHUNK_SIZE;
            }
          },
          false
        );
      </script>
    </body>
  </html>
  ```

  上传文件:

  ```
  //test.txt
  abcdefghijklmnopqrstuvwxyz
  ```

  服务端:

  ```js
  const path = require('path');
  const express = require('express');
  const bodyParser = require('body-parser');

  const app = express();

  app.use(express.static(path.join(__dirname, '')));
  app.use(bodyParser.text());

  app.post('/upload', function (req, res) {
    //输出
    //body abcdefghij
    //body klmnopqrst
    //body uvwxyz
    console.log('body', req.body);
  });

  app.listen(8081, function () {
    console.log('listening on port', 8081);
  });
  ```
