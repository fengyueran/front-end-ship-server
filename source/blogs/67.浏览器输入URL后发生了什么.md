---
title: 浏览器输入URL后发生了什么
date: 2020-5-06 18:10:20
---

## 总体概览

大体上，可以分为六步，当然每一步都可以详细都展开来说，这里先放一张总览图:
![](http://blog-bed.oss-cn-beijing.aliyuncs.com/168.%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BE%93%E5%85%A5URL%E5%90%8E%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/url.png)

### 合成 URL

当在浏览器地址栏输入内容回车后，浏览器首先会对这些输入进行判断是搜索还是网址：

- 搜索
  如果是搜索，则将默认搜索引擎+搜索内容合成新的 URL，比如在地址栏中输入 china，会合成类似`https://www.google.com.hk/search?q=china`的 URL。
- 网址
  如果是网址，则添加上协议合成合法的 URL，比如搜索`www.baidu.com`会生成`http://www.baidu.com/`。

### [DNS 域名解析](./60.DNS%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B.md./60.DNS%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B.md)

### 建立 TCP 连接

首先需要判断是不是 HTTPS，如果是则会有 SSL 握手的过程，服务端和客户端都为加密传输。

- [进行三次握手，建立 TCP 连接](./68.%E8%B0%88%E8%B0%88%E4%BD%A0%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3.md)
- [SSL 握手过程](../questions/89.%E4%BB%8B%E7%BB%8D%20HTTPS%20%E6%8F%A1%E6%89%8B%E8%BF%87%E7%A8%8B.md)

完成了之后，客户端和服务器端就可以开始传送数据。

- 关闭 TCP 连接

### 浏览器渲染

当收到数据后就需要解析渲染数据。渲染的流水线可分为以下几个阶段：构建 DOM 树、样式计算、布局阶段、分层、栅格化和显示。
渲染进程将 HTML 内容转换为能够读懂 DOM 树结构。
渲染引擎将 CSS 样式表转化为浏览器可以理解的 styleSheets，计算出 DOM 节点的样式。
创建布局树，并计算元素的布局信息。
对布局树进行分层，并生成分层树。
为每个图层生成绘制列表，并将其提交到合成线程。合成线程将图层分图块，并栅格化将图块转换成位图。
合成线程发送绘制图块命令给浏览器进程。浏览器进程根据指令生成页面，并显示到显示器上。

- [构建 DOM 树](https://web.dev/critical-rendering-path-constructing-the-object-model/)

浏览器从网络或硬盘中获得 HTML 字节数据后会经过一个流程将字节解析为 DOM 树,先将 HTML 的原始字节数据转换为文件指定编码的字符,然后浏览器会根据 HTML 规范来将字符串转换成各种令牌标签，如 html、body 等。最终解析成一个树状的对象模型，就是 dom 树。

具体步骤：

转码（Bytes -> Characters）—— 读取接收到的 HTML 二进制数据，按指定编码格式将字节转换为 HTML 字符串
Tokens 化（Characters -> Tokens）—— 解析 HTML，将 HTML 字符串转换为结构清晰的 Tokens，每个 Token 都有特殊的含义同时有自己的一套规则
构建 Nodes（Tokens -> Nodes）—— 每个 Node 都添加特定的属性（或属性访问器），通过指针能够确定 Node 的父、子、兄弟关系和所属 treeScope（例如：iframe 的 treeScope 与外层页面的 treeScope 不同）
构建 DOM 树（Nodes -> DOM Tree）—— 最重要的工作是建立起每个结点的父子兄弟关系

样式计算
渲染引擎将 CSS 样式表转化为浏览器可以理解的 styleSheets，计算出 DOM 节点的样式。
CSS 样式来源主要有 3 种，分别是通过 link 引用的外部 CSS 文件、style 标签内的 CSS、元素的 style 属性内嵌的 CSS。,其样式计算过程主要为：

可以看到上面的 CSS 文本中有很多属性值，如 2em、blue、bold，这些类型数值不容易被渲染引擎理解，所以需要将所有值转换为渲染引擎容易理解的、标准化的计算值，这个过程就是属性值标准化。处理完成后再处理样式的继承和层叠，有些文章将这个过程称为 CSSOM 的构建过程。
页面布局
布局过程，即排除  script、meta  等功能化、非视觉节点，排除  display: none  的节点，计算元素的位置信息，确定元素的位置，构建一棵只包含可见元素布局树。如图：

其中，这个过程需要注意的是回流和重绘，关于回流和重绘，详细的可以看我另一篇文章《浏览器相关原理(面试题)详细总结二》，这里就不说了～
生成分层树
页面中有很多复杂的效果，如一些复杂的 3D 变换、页面滚动，或者使用 z-indexing 做 z 轴排序等，为了更加方便地实现这些效果，渲染引擎还需要为特定的节点生成专用的图层，并生成一棵对应的图层树（LayerTree），如图：

如果你熟悉 PS，相信你会很容易理解图层的概念，正是这些图层叠加在一起构成了最终的页面图像。在浏览器中，你可以打开 Chrome 的"开发者工具"，选择"Layers"标签。渲染引擎给页面分了很多图层，这些图层按照一定顺序叠加在一起，就形成了最终的页面。
并不是布局树的每个节点都包含一个图层，如果一个节点没有对应的层，那么这个节点就从属于父节点的图层。那么需要满足什么条件，渲染引擎才会为特定的节点创建新的层呢？详细的可以看我另一篇文章《浏览器相关原理(面试题)详细总结二》，这里就不说了～
栅格化
合成线程会按照视口附近的图块来优先生成位图，实际生成位图的操作是由栅格化来执行的。所谓栅格化，是指将图块转换为位图。如图：

通常一个页面可能很大，但是用户只能看到其中的一部分，我们把用户可以看到的这个部分叫做视口（viewport）。在有些情况下，有的图层可以很大，比如有的页面你使用滚动条要滚动好久才能滚动到底部，但是通过视口，用户只能看到页面的很小一部分，所以在这种情况下，要绘制出所有图层内容的话，就会产生太大的开销，而且也没有必要。
显示
最后，合成线程发送绘制图块命令给浏览器进程。浏览器进程根据指令生成页面，并显示到显示器上，渲染过程完成。
参考资料

极客时间《趣谈网络协议》
极客时间《浏览器工作原理与实践》

最后

欢迎加我微信(winty230)，拉你进技术群，长期交流学习...
欢迎关注「前端 Q」,认真学前端，做个有专业的技术人...

作者：winty
链接：https://juejin.cn/post/6844904054074654728
来源：稀土掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。
