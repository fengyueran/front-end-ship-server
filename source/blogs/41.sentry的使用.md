---
layout: post
title: sentry的使用
category: js
tagline: "Supporting tagline"
tags: [Other]
description:
date: 2019-9-25 18:10:20
---

# [Sentry](https://sentry.io/welcome/)

Sentry 是一个实时的事件日志记录和聚合平台，其专注于错误监控以及提取追踪错误相关的信息而不依赖于用户反馈。使用 sentry 主要有以下两种方式，使用官方服务和自己搭建服务器。

> Sentry's application monitoring platform helps every developer diagnose, fix, and optimize the performance of their code.

### 官方服务

官方的免费服务，对于个人开发者可以使用，当然有一些限制，如不能添加项目成员，数据只保留 30 天等，见下图
![developer](http://blog-bed.oss-cn-beijing.aliyuncs.com/sentry%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/developer.png)
使用官方服务步骤如下：

- [账号注册](https://sentry.io/signup?plan=am1_f&referrer=pricing)
  有了账号就可以登录官方提供的项目管理系统。

- 创建项目
  [登录 sentry](https://sentry.io/auth/login/)，进入项目管理界面后就可以创建项目了，如下图，
  ![create project](http://blog-bed.oss-cn-beijing.aliyuncs.com/sentry%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/create_project.png)

  创建完成后会生成一个与项目相关的 dsn，通过这个 dsn 就可以将对应的项目与 sentry 连接起来了。如果勾选了`Alert me on every new issue`，sentry 收到错误时就会向用户发送邮件，当然也可以通过 sentry 的 Alerts 配置更自由的通知策略。

- 连接项目与 Sentry

  在上一步创建项目成功后，sentry 已经贴心的生成了在前端集成的代码:
  ![created project](http://blog-bed.oss-cn-beijing.aliyuncs.com/sentry%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/created.png)

  我们只需要在前端项目调用 sentry 的初始化接口，如下：

  ```js
  import React from "react";
  import ReactDOM from "react-dom";
  import * as Sentry from "@sentry/react";
  import App from "./App";
  //最简单的配置，只需要项目对应的dsn
  Sentry.init({
    dsn:
      "https://d156e1ba13uu042b5b2ee15fd1c84a7e8@o416397.ingest.sentry.io/5379526",
  });
  ReactDOM.render(<App />, document.getElementById("root"));
  ```

  以上完成以后，sentry 就可以自动捕获所有未 catch 到的错误并发送到 sentry 后台。此外，sentry 还会通过面包屑的方式搜集错误发生时的各种信息，包括 console，网络请求、点击的 button 等信息，如下：
  ![example](http://blog-bed.oss-cn-beijing.aliyuncs.com/sentry%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/example.png)

  这为调试提供了很大的便利，当然，为了能更好的调试 bug 需要根据需要进一步配置或主动捕获信息。
  如果要主动捕获信息，sentry 提供了 api:

  ```js
  Sentry.captureMessage("Something went wrong");
  ```

- 配置用户信息

  为了区分用户，最好配置用户的信息，如果不配置，sentry 收到错误时用户信息只有 IP。

  ```js
  const user = {
    id: "1",
    email: "316032603@qq.com",
    username: "xhm",
    domain: "domain",
  };
  Sentry.init({
    dsn:
      "https://d156e1ba13uu042b5b2ee15fd1c84a7e8@o416397.ingest.sentry.io/5379526",
  });
  Sentry.configureScope(function(scope) {
    scope.setUser(user);
  });
  ```

  配置用户信息后，sentry 捕获到错误时用户信息就有了：
  ![user](http://blog-bed.oss-cn-beijing.aliyuncs.com/41.sentry%E7%9A%84%E4%BD%BF%E7%94%A8/user.png)

  有了用户信息，搜索 bug 就可以在问题搜索框通过用户信息[搜索](https://docs.sentry.io/product/sentry-basics/search/)了：

  ```
  //搜索用户id为1的问题
  user.id:1
  //搜索用户名为xhm的问题
  user.username:xhm
  //不支持自定义的user属性搜索
  user.username:domain=>搜索不到
  ```

- 上传 [sourcemap](https://docs.sentry.io/platforms/javascript/sourcemaps/)到 sentry 后台

  如果 sentry 后台上传了 sourcemap，那么 sentry 搜集到出错误时就能显示出具体的出错代码。
  上传 sourcemap 的方式很多，可以在 webpack 中配置，build 的时候自动上传。

  ```js
  const SentryWebpackPlugin = require("@sentry/webpack-plugin");
  module.exports = {
    // other configuration
    plugins: [
      new SentryWebpackPlugin({
        include: "./build",
        release: "1.0.0",
        configFile: "sentry.properties",
      }),
    ],
  };
  ```

  使用`@sentry/webpack-plugin`插件需要在项目根目录配置 `.sentryclirc`文件

  ```
  // .sentryclirc
  [defaults]
  project=dvfcloud
  org=keyayun
  [auth]
  token=69cd3e75399f41d69f569db2711c8339365aada123c2041609a70c916786xxxx
  ```

  token 在`Settings>Account>API>Auth Tokens`中创建
  ![get token](http://blog-bed.oss-cn-beijing.aliyuncs.com/sentry%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/get_token.png)

  下面来测试一下，代码如下：

  ```js
  //App.js
  import React from "react";
  import * as Sentry from "@sentry/react";

  Sentry.init({
    dsn:
      "https://726ecd0052654e02af76728a9933a8d7@o416397.ingest.sentry.io/5495712",
  });
  function App() {
    return (
      <button
        onClick={() => {
          throw new Error("test sentry");
        }}
      >
        throw
      </button>
    );
  }
  export default App;
  ```

  以上代码，build 后正确上传了 sourcemap，打开网页，点击 button 触发错误，查看 sentry 后台收集到的错误能否定位到具体代码，如下：
  ![get token](http://blog-bed.oss-cn-beijing.aliyuncs.com/41.sentry%E7%9A%84%E4%BD%BF%E7%94%A8/sourcemap.png)
  可以看到的 sentry 正确的定位到了出错的代码。

### 自己搭建服务器

官方提供了[docker](https://github.com/getsentry/onpremise)可以自己搭建服务器。

我们来测试以下主动抛出一个错误，sentry 收到的错误是什么样的。

```js

import * as Sentry from "@sentry/react";
Sentry.init({
  dsn:
    "https://d156e1ba13uu042b5b2ee15fd1c84a7e8@o416397.ingest.sentry.io/5379526",
});

Sentry.configureScope(function(scope) {
  scope.setUser({ id: "1", email: "316032603@qq.com", username: "xhm", domain: 'domain });
});

function App() {
  return (
    <button
      onClick={() => {
        throw new Error("test sentry");
      }}
    >
      throw
    </button>
  );
}

export default App;
```

点击 button sentry 后台收到错误并向用户发送邮件，通过邮件我们就能进入 sentry 项目的后台管理界面，如下：
