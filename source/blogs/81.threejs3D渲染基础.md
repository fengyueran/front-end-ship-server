---
title: threejs3D渲染基础
tags: [Http]
type: SHORT_ANSWER
date: 2022-12-15 18:10:20
---

### threejs 是什么

Three.js 是一个用于创建和展示基于 WebGL 的三维图形的 JavaScript 库。它提供了一系列的功能和工具，使开发者能够在 Web 浏览器中轻松地创建交互式和视觉上引人入胜的三维场景。它简化了直接使用 WebGL 的复杂性，提供了高级的抽象和易用的 API，使得创建和展示三维内容变得更加容易。

### three.js 渲染基本要素

#### [场景(Scene)](https://threejs.org/docs/#api/zh/scenes/Scene)

场景是一个容器，需要渲染的物体都要添加到场景中。可以把场景当作一个空的摄影棚，摄影棚里可以放置拍摄相关的东西，比如模特、相机、灯光等各种物体。
![](http://blog-bed.oss-cn-beijing.aliyuncs.com/80.%E5%AE%9E%E7%8E%B0dicom-viewer/scene.png)

#### [相机(Camera)](https://threejs.org/docs/?q=came#api/zh/cameras/Camera)

相机用来确定观察的位置、方向、角度，相机看到的内容就是最终呈现在屏幕上的内容。试想一下，当我们在摄影棚调整相机，随着相机位置、方向、角度的变化所看到的画面是不一样的。

**正交投影相机:**
正交投影相机(Orthographic Camera)定义了一个长方体的空间，由相机的左、右、上、下、近、远六个裁剪面决定，在长方体内的物体会被渲染，在长方体外的会被裁剪掉。

正交投影相机的主要特点是能够让近处、远处的物体大小尺寸保持一致，常适用于工程制图、建模软件。

<!-- ![](http://blog-bed.oss-cn-beijing.aliyuncs.com/80.%E5%AE%9E%E7%8E%B0dicom-viewer/orthographic-projection.png) -->

```js
//width、height 定义了长方体空间的宽度和高度
const width = 100;
const height = 180;
const left = -width / 2; // 左截面的位置
const right = width / 2; // 右截面的位置
const top = height / 2; // 上截面的位置
const bottom = -height / 2; // 下截面的位置
const near = 0.1; // 近截面的位置
const far = 100; // 远截面的位置

const camera = new THREE.OrthographicCamera(
  left,
  right,
  top,
  bottom,
  near,
  far
);
```

![](https://blog-bed.oss-cn-beijing.aliyuncs.com/81.threejs3D%E6%B8%B2%E6%9F%93%E5%9F%BA%E7%A1%80/orthographic-camera.webp)

**透视投影相机:**
透视投影相机(Perspective Camera)是 Three.js 中最常用的相机类型之一，与正交相机不同，透视相机模拟了人眼观察物体的方式，使得离相机越近的物体看起来越大，离相机越远的物体看起来越小。

```js
const width = window.innerWidth;
const height = window.innerHeight;
const fov = 75; // 像机视锥体垂直视野角度
const aspect = width / height; //摄像机视锥体长宽比
const near = 0.1; // 摄像机视锥体近平面
const far = 1000; // 摄像机视锥体远平面
//通过这4个参数，可以画出一个视锥体
const camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
```

![](http://blog-bed.oss-cn-beijing.aliyuncs.com/80.%E5%AE%9E%E7%8E%B0dicom-viewer/perspective-road.png)

视椎体示意图:

<!-- ![](http://blog-bed.oss-cn-beijing.aliyuncs.com/80.%E5%AE%9E%E7%8E%B0dicom-viewer/perspective-projection.png) -->

![](https://blog-bed.oss-cn-beijing.aliyuncs.com/81.threejs3D%E6%B8%B2%E6%9F%93%E5%9F%BA%E7%A1%80/perspective-camera.webp)

正交投影 vs 透视投影:
![](http://blog-bed.oss-cn-beijing.aliyuncs.com/80.%E5%AE%9E%E7%8E%B0dicom-viewer/per-vs-orth.png)

#### 常用方法

- lookAt

  lookAt 函数是 Camera 对象的一个方法，它允许相机聚焦于场景中的特定点。这对于将相机指向某个对象或位置非常有用，确保视图以该特定点或对象为中心。

  lookAt 方法的工作原理

  lookAt 方法改变相机的方向，使其朝向一个 THREE.Vector3 对象指定的点。当你调用这个方法时，相机的朝向会自动调整，以便其“看向”给定的坐标。

  使用 lookAt 方法

  使用 lookAt 方法时，你需要传递一个 THREE.Vector3 实例作为参数，表示相机应该朝向的坐标。以下是如何使用这个方法的示例：

  ```js
  // 首先，创建一个场景、相机和渲染器
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
  );
  const renderer = new THREE.WebGLRenderer();

  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // 创建一个立方体
  const geometry = new THREE.BoxGeometry();
  const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
  const cube = new THREE.Mesh(geometry, material);
  cube.position.x = 10;
  scene.add(cube);

  // 设置相机位置
  camera.position.z = 15;

  /*
  因为 cube.position.x = 10;cube偏离了场景中心(默认x为0)，如果不设置camera.lookAt(cube.position)，
  我们看到的cube就位于画布右侧(因为相机是对着画布中心)，而使用了lookAt后，使得相机对准了cube，所以看上去cube就位于画布中心
  */
  camera.lookAt(cube.position);

  // 渲染场景和相机
  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }
  animate();
  ```

  注意事项

  - 更新相机矩阵：在使用 lookAt 方法后，如果相机的位置或任何相关属性（如 up 向量）被修改，可能需要更新相机的矩阵。这可以通过调用 camera.updateMatrixWorld(); 完成。
  - 相机控制：如果你使用了 OrbitControls 或类似的控制器来控制相机，可能需要在设置 lookAt 后重新初始化控制器，因为控制器可能会存储和维护自己的相机目标状态。

#### 渲染器（renderer）

#### 光(Light)

和真实世界一样没有光是看不到任何物体的，因此需要向场景中添加光源。为了和真实世界更加贴近，Threejs 支持模拟不同光源，展现不同光照效果，有点光源、平行光、聚光灯、环境光等。 不同的光与物体反射能够得到不同的效果。
![](http://blog-bed.oss-cn-beijing.aliyuncs.com/80.%E5%AE%9E%E7%8E%B0dicom-viewer/light.png)

- 平行光

  平行光即光线是相互平行的光，平行光具有方向性，可以看作是无限远处(比如太阳)发出的光。平行光只需要一个方向和一个颜色就能定义。

- 点光源

  点光源是从一个点向周围所有方向发出的光，就像灯泡、火焰等，用光源的位置和颜色来定义。

- 环境光

  环境光(间接光)指那些经光源(点光源和平行光)发出后，被墙壁或物体多次反射，然后照到物体上的光。环境光从各个角度照射物体，其强度都是一致的，只需要用颜色来定义。

- 聚光灯

  光线从一个点出发沿着圆椎体，随着光线照射的变远，光线圆锥体的尺寸也逐渐增大，类似手电筒产生的光源。

### 数学知识

#### [向量点乘与叉乘的概念及几何意义](https://zhuanlan.zhihu.com/p/359975221)

https://blog.51cto.com/u_15304158/3145213

#### [Quaternions](https://zh.wikipedia.org/wiki/%E5%9B%9B%E5%85%83%E6%95%B8)

在三维图形和物理模拟中，四元数（Quaternions）是一种非常重要的数学工具，用于表示和计算旋转。四元数提供了一种比欧拉角和旋转矩阵更有效、更稳定的方法来处理 3D 空间中的旋转。

四元数的组成

四元数是由一个实部和三个虚部组成的四维复数。一般表示为：

q = w + xi + yj + zk

其中：w, x, y, z 是实数。 i, j, k 是四元数的虚单位，满足 i^2 = j^2 = k^2 = ijk = -1 。

这使得它们可以编码旋转轴和旋转角度。一个单位四元数（模长为 1 的四元数）可以表示为：

q = cos(θ/2) + sin(θ/2)(xi + yj + zk)

其中 θ 是旋转角度， (x, y, z) 是单位旋转轴， i, j, k 是四元数的虚单位。

在计算机图形学中，四元数常用于以下场景：

- 场景旋转：在 3D 环境中控制相机或物体的旋转。
- 动画：四元数用于骨骼动画系统中的关节旋转，可以创建平滑过渡的动作。
- 物理模拟：在物理引擎中用于旋转物体，特别是在处理复杂的运动和碰撞反应时。

在 Three.js 中，四元数广泛用于处理和控制对象的旋转。下面是一个简单的示例，展示如何使用四元数来旋转一个对象：

```js
const object = new THREE.Mesh(geometry, material);

// 创建一个四元数
const quaternion = new THREE.Quaternion();
quaternion.setFromAxisAngle(new THREE.Vector3(0, 1, 0), Math.PI / 2); // 沿Y轴旋转90度

// 应用四元数到物体
object.quaternion.multiply(quaternion);

// 或者直接设置四元数
object.quaternion.copy(quaternion);
```

- 三维空间中两个点相减

### shader 基础知识
