---
title: JavaScript 的垃圾回收机制
tags: [JavaScript]
type: SHORT_ANSWER
date: 2017-5-08 18:10:20
---

JavaScript 有自动垃圾回收机制，当然这并不意味着你不需要关心内存管理。
内存的生命周期大致分为内存的分配、内存的使用以及不需要时内存的释放。因此只要追踪内存的生命周期就能自动的对内存进行分配回收了，但是这并不容易，尤其要确定某块内存是否真的不需要了。因此，垃圾回收只能有限制的解决一般问题，主要有两种方法，引用计数和标记清除算法。

- 引用计数法

  在内存管理环境中，如果一个对象(包括函数作用域、全局词法作用域等)有访问另一个对象的权限，叫做一个对象引用另一个对象。当对象被引用的次数为 0 时就被回收。

  ```
  var a = { v: 1 }; // 对象{ v: 1 }被变量a引用一次，引用计数为1
  var b = a; // 同样，对象{ v: 1 }被变量b引用一次，引用计数为2
  a = null; // 对象引用次数减1
  b = null;// 对象引用次数减1，此时引用计数为0，对象可以被释放
  ```

  引用计数有一个潜在的问题，就是无法解决循环引用的问题。
  如下，a、b 互相引用，引用计数一直为 1，导致不能自动回收。

  ```
    function f() {
      var a = {};
      var b = {};
      a.value = b;
      b.value = a;
    }
    f();
  ```

- 标记清除算法

  这个算法假定有一个叫跟(root)的对象(js 中为 window， node js 为 global)，垃圾回收器定期从根开始，找所有从根开始引用的对象，然后找这些引用对象引用的对象...将这些对象标记为 active，其他的不能被根引用或间接引用的将被标记为 garbage，最终将这些垃圾清除。
  循环引用将不再是问题，上例中函数 f 执行完后，全局 window 就无法访问到对象 a 和 b 了，因此对象 a、b 将会被回收。

  <center><img alt="标记清除意图" src="https://i.imgur.com/N9bb66Q.gif" width="500" /></center>
